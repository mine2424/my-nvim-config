#!/usr/bin/env zsh
# ========================================
# Zsh Configuration
# 対話型シェル用の設定
# ========================================

# ========================================
# Performance Profiling (Optional)
# ========================================
# Uncomment to enable profiling
# zmodload zsh/zprof

# ========================================
# Zsh Options
# ========================================

# History
setopt EXTENDED_HISTORY       # Write the history file in the ":start:elapsed;command" format
setopt INC_APPEND_HISTORY     # Write to the history file immediately, not when the shell exits
setopt SHARE_HISTORY          # Share history between all sessions
setopt HIST_EXPIRE_DUPS_FIRST # Expire duplicate entries first when trimming history
setopt HIST_IGNORE_DUPS       # Don't record an entry that was just recorded again
setopt HIST_IGNORE_ALL_DUPS   # Delete old recorded entry if new entry is a duplicate
setopt HIST_FIND_NO_DUPS      # Do not display a line previously found
setopt HIST_IGNORE_SPACE      # Don't record an entry starting with a space
setopt HIST_SAVE_NO_DUPS      # Don't write duplicate entries in the history file
setopt HIST_REDUCE_BLANKS     # Remove superfluous blanks before recording entry
setopt HIST_VERIFY            # Don't execute immediately upon history expansion

# Directory Navigation
setopt AUTO_CD                # Auto change directory when typing directory name
setopt AUTO_PUSHD             # Push the old directory onto the stack on cd
setopt PUSHD_IGNORE_DUPS      # Don't push multiple copies of the same directory
setopt PUSHD_MINUS            # Exchange the meanings of '+' and '-'
setopt PUSHD_SILENT           # Do not print the directory stack after pushd or popd
setopt PUSHD_TO_HOME          # Push to home directory when no argument is given

# Completion
setopt COMPLETE_IN_WORD       # Complete from both ends of a word
setopt ALWAYS_TO_END          # Move cursor to the end of a completed word
setopt PATH_DIRS              # Perform path search even on command names with slashes
setopt AUTO_MENU              # Show completion menu on a successive tab press
setopt AUTO_LIST              # Automatically list choices on ambiguous completion
setopt AUTO_PARAM_SLASH       # If completed parameter is a directory, add a trailing slash
setopt MENU_COMPLETE          # Insert first match immediately

# Globbing
setopt EXTENDED_GLOB          # Use extended globbing syntax
setopt GLOB_DOTS              # Include dotfiles in globbing

# Other
setopt INTERACTIVE_COMMENTS   # Allow comments in interactive shell
setopt NO_BEEP                # Don't beep on error
setopt MULTIOS                # Perform implicit tees or cats when multiple redirections are attempted

# ========================================
# Completion System
# ========================================

# Set ZSH cache directory
export ZSH_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/zsh"

# Ensure cache directories exist
[[ ! -d "$ZSH_CACHE_DIR" ]] && mkdir -p "$ZSH_CACHE_DIR"
[[ ! -d "$ZSH_CACHE_DIR/completions" ]] && mkdir -p "$ZSH_CACHE_DIR/completions"

# Initialize completion system
autoload -Uz compinit

# Speed up compinit by checking cache once per day
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qNmh+24) ]]; then
    compinit
else
    compinit -C
fi

# Completion styling
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*:warnings' format '%F{red}-- no matches found --%f'
zstyle ':completion:*:messages' format '%F{purple}-- %d --%f'
zstyle ':completion:*:corrections' format '%F{green}-- %d (errors: %e) --%f'
zstyle ':completion:*' group-name ''
zstyle ':completion:*' verbose yes

# Completion caching
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "${XDG_CACHE_HOME:-$HOME/.cache}/zsh/zcompcache"

# Process completion
zstyle ':completion:*:*:*:*:processes' command 'ps -u $USER -o pid,user,comm -w'
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=0=01'

# ========================================
# Plugin Management with Sheldon
# ========================================

if command -v sheldon &> /dev/null; then
    # Ensure config directory exists
    [[ ! -d "${XDG_CONFIG_HOME:-$HOME/.config}/sheldon" ]] && \
        mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/sheldon"
    
    # Load plugins
    eval "$(sheldon source)"
fi

# ========================================
# Key Bindings
# ========================================

# Use Emacs key bindings
bindkey -e

# History search
autoload -Uz up-line-or-beginning-search down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search

bindkey '^[[A' up-line-or-beginning-search      # Up arrow
bindkey '^[[B' down-line-or-beginning-search    # Down arrow
bindkey '^P' up-line-or-beginning-search        # Ctrl+P
bindkey '^N' down-line-or-beginning-search      # Ctrl+N

# Other useful bindings
bindkey '^R' history-incremental-search-backward  # Ctrl+R
bindkey '^S' history-incremental-search-forward   # Ctrl+S
bindkey '^A' beginning-of-line                    # Ctrl+A
bindkey '^E' end-of-line                          # Ctrl+E
bindkey '^K' kill-line                            # Ctrl+K
bindkey '^U' backward-kill-line                   # Ctrl+U
bindkey '^W' backward-kill-word                   # Ctrl+W
bindkey '^Y' yank                                 # Ctrl+Y

# ========================================
# Aliases
# ========================================

# Editor
alias v='nvim'

# Directory Navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'
alias -- -='cd -'  # Go to previous directory

# Modern Command Replacements
if command -v eza &> /dev/null; then
    alias ls='eza --icons --git'
    alias ll='eza -l --icons --git --header'
    alias la='eza -la --icons --git --header'
    alias lt='eza --tree --level=2 --icons --git'
    alias lta='eza --tree --level=2 -la --icons --git'
    alias tree='eza --tree --icons --git'
else
    alias ll='ls -lh'
    alias la='ls -lAh'
fi

if command -v bat &> /dev/null; then
    alias cat='bat --paging=never'
    alias less='bat'
fi

if command -v fd &> /dev/null; then
    alias find='fd'
fi

if command -v rg &> /dev/null; then
    alias grep='rg'
fi

if command -v procs &> /dev/null; then
    alias ps='procs'
fi

if command -v dust &> /dev/null; then
    alias du='dust'
fi

if command -v duf &> /dev/null; then
    alias df='duf'
fi

if command -v btop &> /dev/null; then
    alias top='btop'
elif command -v htop &> /dev/null; then
    alias top='htop'
fi

# Git Aliases
alias g='git'
alias gs='git status'
alias gst='git status'
alias ga='git add'
alias gaa='git add --all'
alias gc='git commit'

# Codex: run inside tmux to preserve scrollback in Ghostty
codex() {
    if command -v tmux >/dev/null 2>&1 && [[ -z "${TMUX-}" ]]; then
        local tty_name session_name
        tty_name="$(tty 2>/dev/null | awk -F/ '{print $NF}')"
        if [[ -n "$tty_name" ]]; then
            session_name="codex-${tty_name//./-}"
        else
            session_name="codex-$$"
        fi
        tmux new-session -A -s "$session_name" -- command codex "$@"
    else
        command codex "$@"
    fi
}
alias gcm='git commit -m'
alias gca='git commit --amend'
alias gp='git push'
alias gpl='git pull'
alias gl='git log --oneline --graph --decorate'
alias gla='git log --oneline --graph --decorate --all'
alias gd='git diff'
alias gds='git diff --staged'
alias gb='git branch'
alias gba='git branch -a'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gm='git merge'
alias gr='git rebase'
alias gri='git rebase -i'
alias gf='git fetch'
alias gfa='git fetch --all'
alias gst='git stash'
alias gstp='git stash pop'
alias gstl='git stash list'

# Lazygit
if command -v lazygit &> /dev/null; then
    alias lg='lazygit'
fi

# Docker
alias dk='docker'
alias dkc='docker compose'
alias dkps='docker ps'
alias dkpsa='docker ps -a'
alias dki='docker images'
alias dkrm='docker rm'
alias dkrmi='docker rmi'
alias dkl='docker logs'
alias dklf='docker logs -f'

# Kubernetes
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgs='kubectl get services'
alias kgd='kubectl get deployments'
alias kl='kubectl logs'
alias klf='kubectl logs -f'
alias kd='kubectl describe'
alias kdel='kubectl delete'

# Flutter/Dart
alias fl='flutter'
alias flr='flutter run'
alias flb='flutter build'
alias flt='flutter test'
alias flc='flutter clean'
alias flpg='flutter pub get'
alias flpu='flutter pub upgrade'
alias fld='flutter doctor'
alias fldev='flutter devices'

# Melos (monorepo management)
if command -v melos &> /dev/null; then
    alias ml='melos'
    alias mlb='melos bootstrap'
    alias mlc='melos clean'
    alias mlr='melos run'
    alias mlt='melos test'
fi

# Claude
alias cl='claude'
alias cld='claude --dangerously-skip-permissions'
alias rcl='claude --resume'

# OpenCode
if command -v opencode &> /dev/null; then
    alias oc='opencode'
    alias oca='opencode auth'
    alias ocl='opencode auth login'
    alias ocm='opencode models'
    alias ocs='opencode share'
    alias ocus='opencode unshare'
fi

# Utility
alias reload='exec zsh'
alias myip='curl -s https://api.ipify.org && echo'
alias weather='curl wttr.in'
alias ports='netstat -tulanp'

# Safety
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# ========================================
# Functions
# ========================================

# Create directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Extract various archive formats
extract() {
    if [[ ! -f "$1" ]]; then
        echo "Error: '$1' is not a valid file"
        return 1
    fi
    
    case "$1" in
        *.tar.bz2)   tar xjf "$1"     ;;
        *.tar.gz)    tar xzf "$1"     ;;
        *.tar.xz)    tar xJf "$1"     ;;
        *.bz2)       bunzip2 "$1"     ;;
        *.rar)       unrar x "$1"     ;;
        *.gz)        gunzip "$1"      ;;
        *.tar)       tar xf "$1"      ;;
        *.tbz2)      tar xjf "$1"     ;;
        *.tgz)       tar xzf "$1"     ;;
        *.zip)       unzip "$1"       ;;
        *.Z)         uncompress "$1"  ;;
        *.7z)        7z x "$1"        ;;
        *)
            echo "Error: '$1' cannot be extracted via extract()"
            return 1
            ;;
    esac
}

# Quick backup of file
backup() {
    if [[ ! -f "$1" ]]; then
        echo "Error: '$1' is not a valid file"
        return 1
    fi
    cp "$1" "$1.backup-$(date +%Y%m%d-%H%M%S)"
    echo "Backed up: $1"
}

# Find and cd to directory
fcd() {
    local dir
    dir=$(fd --type d --hidden --follow --exclude .git | fzf --preview 'eza --tree --level=2 --icons {}' --preview-window=right:50%) && cd "$dir"
}

# Find and open file in editor
fv() {
    local file
    file=$(fd --type f --hidden --follow --exclude .git | fzf --preview 'bat --color=always --style=numbers {}' --preview-window=right:60%) && ${EDITOR:-nvim} "$file"
}

# Git checkout branch with fzf
fgb() {
    local branch
    branch=$(git branch --all | grep -v HEAD | sed 's/^[* ]*//' | sed 's#remotes/origin/##' | sort -u | fzf --preview 'git log --oneline --graph --color=always {}' --preview-window=right:60%) && git checkout "$branch"
}

# Kill process with fzf
fkill() {
    local pid
    pid=$(ps -ef | sed 1d | fzf -m --preview 'echo {}' --preview-window=down:3:wrap | awk '{print $2}')
    if [[ -n "$pid" ]]; then
        echo "$pid" | xargs kill -"${1:-9}"
    fi
}

# OpenCode helper functions
if command -v opencode &> /dev/null; then
    # Quick OpenCode session with model selection
    ocq() {
        local model="${1:-GLM-4.7}"
        opencode --model "$model" "${@:2}"
    }
    
    # OpenCode with file context
    ocf() {
        if [[ -z "$1" ]]; then
            echo "Usage: ocf <file> [additional args]"
            echo "Example: ocf src/main.rs 'explain this code'"
            return 1
        fi
        opencode --file "$1" "${@:2}"
    }
    
    # OpenCode GitHub workflow helper
    ocgh() {
        if [[ ! -d .git ]]; then
            echo "Error: Not a git repository"
            return 1
        fi
        if [[ -z "$1" ]]; then
            echo "Usage: ocgh <command>"
            echo "Commands:"
            echo "  install  - Install OpenCode GitHub workflow"
            echo "  explain  - Explain current issue (use in GitHub issue)"
            echo "  fix      - Fix current issue (use in GitHub issue)"
            return 1
        fi
        case "$1" in
            install)
                opencode github install
                ;;
            *)
                echo "Unknown command: $1"
                return 1
                ;;
        esac
    }
fi

# ========================================
# FZF Configuration
# ========================================

if command -v fzf &> /dev/null; then
    # Use fd for FZF if available
    if command -v fd &> /dev/null; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
    fi
    
    # Load FZF key bindings if available
    if [[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/fzf/fzf.zsh" ]]; then
        source "${XDG_CONFIG_HOME:-$HOME/.config}/fzf/fzf.zsh"
    elif [[ -f ~/.fzf.zsh ]]; then
        source ~/.fzf.zsh
    fi
fi

# ========================================
# Tool Integrations
# ========================================

# Direnv
if command -v direnv &> /dev/null; then
    eval "$(direnv hook zsh)"
fi

# Zoxide (better cd)
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init zsh)"
    alias cd='z'
fi

# Starship Prompt
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi

# ========================================
# Local Configuration
# ========================================

# Source local configuration if it exists
[[ -f "${ZDOTDIR:-$HOME}/.zshrc.local" ]] && source "${ZDOTDIR:-$HOME}/.zshrc.local"

# ========================================
# Performance Profiling (Optional)
# ========================================
# Uncomment to show profiling results
# zprof

# OpenCode
if [[ -d "$HOME/.opencode/bin" ]]; then
    export PATH="$HOME/.opencode/bin:$PATH"
fi

# Codex helpers
if [[ -d "$HOME/development/dotfiles/codex/bin" ]]; then
    export PATH="$HOME/development/dotfiles/codex/bin:$PATH"
fi
