#!/bin/bash

# ========================================
# Neovim + Tmux ã‚¯ã‚¤ãƒƒã‚¯èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ========================================
# ä½¿ç”¨ä¾‹:
#   dev                    # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§èµ·å‹•
#   dev ~/project          # æŒ‡å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§èµ·å‹•
#   dev myproject ~/code   # ã‚»ãƒƒã‚·ãƒ§ãƒ³åã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæŒ‡å®š
#   dev --layout split     # åˆ†å‰²ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
#   dev --layout full      # ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
#   dev --layout claude    # Claude Codeä½µç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

set -e

# ========================================
# è¨­å®š
# ========================================

DEFAULT_LAYOUT="claude"  # split, full, claude
SESSION_PREFIX="dev"

# ========================================
# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
# ========================================

show_help() {
  cat << EOF
Usage: dev [OPTIONS] [SESSION_NAME] [PROJECT_DIR]

Neovim + Tmuxé–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã™ã€‚

Arguments:
  SESSION_NAME    ã‚»ãƒƒã‚·ãƒ§ãƒ³åï¼ˆçœç•¥æ™‚: ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåï¼‰
  PROJECT_DIR     ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆçœç•¥æ™‚: ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰

Options:
  -l, --layout LAYOUT    ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé¸æŠ (split|full|claude)
                         claude: Claude Codeä½µç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                         split:  ã‚¨ãƒ‡ã‚£ã‚¿ + ã‚¿ãƒ¼ãƒŸãƒŠãƒ«åˆ†å‰²
                         full:   ã‚¨ãƒ‡ã‚£ã‚¿ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
  -h, --help            ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

Layouts:
  split:   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Neovim (70%)    â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ Terminal (30%)  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  full:    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚
           â”‚ Neovim (100%)   â”‚
           â”‚                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  claude:  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
           â”‚          â”‚ Git  â”‚
           â”‚ Neovim   â”œâ”€â”€â”€â”€â”€â”€â”¤
           â”‚ (60%)    â”‚ Term â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
           â€» Claude Codeã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ä½¿ç”¨

Examples:
  dev                           # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§èµ·å‹•
  dev myproject                 # myprojectã‚»ãƒƒã‚·ãƒ§ãƒ³ã§èµ·å‹•
  dev myproject ~/code/myapp    # æŒ‡å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§èµ·å‹•
  dev --layout claude           # Claudeä½µç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  dev -l full myproject         # ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

EOF
}

# ========================================
# å¼•æ•°è§£æ
# ========================================

LAYOUT="$DEFAULT_LAYOUT"
SESSION_NAME=""
PROJECT_DIR=""

while [[ $# -gt 0 ]]; do
  case $1 in
    -l|--layout)
      LAYOUT="$2"
      shift 2
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      if [ -z "$SESSION_NAME" ]; then
        SESSION_NAME="$1"
      elif [ -z "$PROJECT_DIR" ]; then
        PROJECT_DIR="$1"
      fi
      shift
      ;;
  esac
done

# ========================================
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
# ========================================

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
if [ -z "$PROJECT_DIR" ]; then
  PROJECT_DIR="$(pwd)"
fi

# ã‚»ãƒƒã‚·ãƒ§ãƒ³åã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‹ã‚‰ç”Ÿæˆï¼‰
if [ -z "$SESSION_NAME" ]; then
  SESSION_NAME="${SESSION_PREFIX}-$(basename "$PROJECT_DIR")"
fi

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
if [ ! -d "$PROJECT_DIR" ]; then
  echo "Error: Directory not found: $PROJECT_DIR"
  exit 1
fi

# ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ¤œè¨¼
if [[ ! "$LAYOUT" =~ ^(split|full|claude)$ ]]; then
  echo "Error: Invalid layout: $LAYOUT"
  echo "Valid layouts: split, full, claude"
  exit 1
fi

# ========================================
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆé–¢æ•°
# ========================================

create_split_layout() {
  local session=$1
  local dir=$2
  
  # ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: editor
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  tmux send-keys -t "$session:editor" "nvim" C-m
  
  # ã‚¨ãƒ‡ã‚£ã‚¿ãƒšã‚¤ãƒ³ã‚’åˆ†å‰²ï¼ˆä¸‹30%ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
  tmux split-window -t "$session:editor" -v -p 30 -c "$dir"
  
  # ã‚¨ãƒ‡ã‚£ã‚¿ãƒšã‚¤ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  tmux select-pane -t "$session:editor.0"
}

create_full_layout() {
  local session=$1
  local dir=$2
  
  # ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: editorï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  tmux send-keys -t "$session:editor" "nvim" C-m
  
  # åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: terminal
  tmux new-window -t "$session" -n "terminal" -c "$dir"
  
  # ã‚¨ãƒ‡ã‚£ã‚¿ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æˆ»ã‚‹
  tmux select-window -t "$session:editor"
}

create_claude_layout() {
  local session=$1
  local dir=$2
  
  # ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: editor
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  tmux send-keys -t "$session:editor" "nvim" C-m
  
  # å³å´ã«ç¸¦åˆ†å‰²ï¼ˆ40%ï¼‰
  tmux split-window -t "$session:editor" -h -p 40 -c "$dir"
  
  # å³ãƒšã‚¤ãƒ³ã‚’æ¨ªåˆ†å‰²ï¼ˆä¸Š50%: gitã€ä¸‹50%: terminalï¼‰
  tmux split-window -t "$session:editor.1" -v -p 50 -c "$dir"
  tmux send-keys -t "$session:editor.1" "git status" C-m
  
  # ã‚¨ãƒ‡ã‚£ã‚¿ãƒšã‚¤ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  tmux select-pane -t "$session:editor.0"
  
  echo ""
  echo "ğŸ’¡ Claude Codeä½µç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆå®Œäº†"
  echo "   - å·¦: Neovim (60%)"
  echo "   - å³ä¸Š: Git (20%)"
  echo "   - å³ä¸‹: Terminal (20%)"
  echo ""
  echo "   Claude Codeã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã„ã¦ãã ã•ã„"
  echo "   æ¨å¥¨: WezTermã®åˆ¥ã‚¿ãƒ–ã¾ãŸã¯OSã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ†å‰²æ©Ÿèƒ½ã‚’ä½¿ç”¨"
}

# ========================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ========================================

# æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèª
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "ğŸ“Œ ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$SESSION_NAME' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
  echo "   ã‚¢ã‚¿ãƒƒãƒã—ã¦ã„ã¾ã™..."
  
  # Tmuxå†…ã‹ã‚‰å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$SESSION_NAME"
  else
    tmux attach-session -t "$SESSION_NAME"
  fi
  exit 0
fi

# æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
echo "ğŸš€ ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$SESSION_NAME' ã‚’ä½œæˆä¸­..."
echo "   ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $PROJECT_DIR"
echo "   ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: $LAYOUT"
echo ""

case "$LAYOUT" in
  split)
    create_split_layout "$SESSION_NAME" "$PROJECT_DIR"
    ;;
  full)
    create_full_layout "$SESSION_NAME" "$PROJECT_DIR"
    ;;
  claude)
    create_claude_layout "$SESSION_NAME" "$PROJECT_DIR"
    ;;
esac

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
if [ -n "$TMUX" ]; then
  tmux switch-client -t "$SESSION_NAME"
else
  tmux attach-session -t "$SESSION_NAME"
fi
