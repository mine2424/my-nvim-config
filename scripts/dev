#!/bin/bash

# ========================================
# Neovim + Tmux devレイアウト起動スクリプト
# ========================================
#
# 【概要】
#   NeovimとTmuxを統合した開発環境を起動するスクリプトです。
#   devレイアウト（左半分Neovim、右半分上下ターミナル）でtmuxセッションを作成します。
#
# 【使用方法】
#   dev                           # カレントディレクトリで起動
#   dev ~/project                 # 指定ディレクトリで起動
#   dev myproject ~/code          # セッション名とディレクトリ指定
#
# 【レイアウト】
#   - dev:   左半分Neovim、右半分を上下に分割したターミナル
#
# 【他のレイアウト】
#   - claudeレイアウト（右5分割）を使用する場合は、agentコマンドを使用してください
#     agent                           # claudeレイアウトで起動
#
# 【編集時の注意点】
#   - tmuxのペイン番号は0から始まります
#   - split-windowは現在のペインを分割し、新しいペインを作成します
#   - ペイン分割の順序が重要です（先にNeovimを起動してから分割する）
#
# 【tmuxコマンドの説明】
#   - new-session: 新しいセッションを作成
#   - split-window: ペインを分割（-h: 縦分割、-v: 横分割、-p: パーセンテージ）
#   - select-pane: ペインを選択
#   - send-keys: キーを送信（C-m: Enterキー）
#   - has-session: セッションの存在確認
#   - switch-client: クライアントを別セッションに切り替え
#   - attach-session: セッションにアタッチ

set -e

# ========================================
# 設定
# ========================================
#
# 【設定項目】
#   SESSION_PREFIX: セッション名のプレフィックス（省略時は "dev-" が付与される）

SESSION_PREFIX="dev"

# ========================================
# ヘルプ表示
# ========================================

show_help() {
  cat << EOF
Usage: dev [OPTIONS] [SESSION_NAME] [PROJECT_DIR]

Neovim + Tmux開発環境を起動します（devレイアウト）。

Arguments:
  SESSION_NAME    セッション名（省略時: カレントディレクトリ名）
  PROJECT_DIR     プロジェクトディレクトリ（省略時: カレントディレクトリ）

Options:
  -h, --help            このヘルプを表示

Layout:
  dev:    ┌──────────┬──────────┐
          │          │ Terminal │
          │ Neovim   │ (上)     │
          │ (50%)    ├──────────┤
          │          │ Terminal │
          │          │ (下)     │
          └──────────┴──────────┘

Examples:
  dev                           # カレントディレクトリで起動
  dev myproject                 # myprojectセッションで起動
  dev myproject ~/code/myapp    # 指定ディレクトリで起動

EOF
}

# ========================================
# 引数解析
# ========================================
#
# 【引数の優先順位】
#   1. オプション（-l, --layout, -h, --help）
#   2. 最初の引数: セッション名
#   3. 2番目の引数: プロジェクトディレクトリ
#
# 【例】
#   dev myproject ~/code
#   → SESSION_NAME="myproject", PROJECT_DIR="~/code"
#
#   dev --layout claude myproject
#   → LAYOUT="claude", SESSION_NAME="myproject"

SESSION_NAME=""
PROJECT_DIR=""

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      # 最初の引数はセッション名、2番目はプロジェクトディレクトリ
      if [ -z "$SESSION_NAME" ]; then
        SESSION_NAME="$1"
      elif [ -z "$PROJECT_DIR" ]; then
        PROJECT_DIR="$1"
      fi
      shift
      ;;
  esac
done

# ========================================
# デフォルト値設定
# ========================================
#
# 【デフォルト値の決定ロジック】
#   1. PROJECT_DIR: 未指定時はカレントディレクトリ（$(pwd)）
#   2. SESSION_NAME: 未指定時は "dev-<ディレクトリ名>" 形式で生成

# プロジェクトディレクトリのデフォルト
if [ -z "$PROJECT_DIR" ]; then
  PROJECT_DIR="$(pwd)"
fi

# セッション名のデフォルト（ディレクトリ名から生成）
# 例: ~/code/myproject → "dev-myproject"
if [ -z "$SESSION_NAME" ]; then
  SESSION_NAME="${SESSION_PREFIX}-$(basename "$PROJECT_DIR")"
fi

# ディレクトリの存在確認
if [ ! -d "$PROJECT_DIR" ]; then
  echo "Error: Directory not found: $PROJECT_DIR"
  exit 1
fi

# ========================================
# セッション作成関数
# ========================================
#
# 【関数の役割】
#   各レイアウトに応じてtmuxセッションとペインを構成します。
#
# 【引数】
#   $1: session - tmuxセッション名
#   $2: dir     - 作業ディレクトリ
#
# 【tmuxペイン番号の説明】
#   - ペイン番号は0から始まります
#   - split-windowで分割すると、元のペインと新しいペインが作成されます
#   - 例: ペイン0を分割 → ペイン0（左）とペイン1（右）が作成される
#   - ペイン1を分割 → ペイン1（上）とペイン2（下）が作成される
#
# 【編集時の注意点】
#   - 新しいレイアウト関数を追加する場合は、このパターンに従ってください
#   - ペイン分割の順序が重要です（先に分割してからNeovimを起動）
#   - sleep 0.1 は分割完了を待つための待機時間です

# ========================================
# devレイアウト: 左半分Neovim、右半分上下ターミナル
# ========================================
# 【レイアウト構造】
#   ┌──────────┬──────────┐
#   │          │ Terminal │
#   │ Neovim   │ (上)     │
#   │ (50%)    ├──────────┤
#   │          │ Terminal │
#   │          │ (下)     │
#   └──────────┴──────────┘
#
# 【ペイン構成】
#   - ペイン0: Neovim（左50%）
#   - ペイン1: ターミナル（右上25%）
#   - ペイン2: ターミナル（右下25%）
#
create_dev_layout() {
  local session=$1
  local dir=$2
  
  # ステップ1: セッションを作成（ペイン0が作成される）
  # -d: デタッチモードで作成（すぐにアタッチしない）
  # -n: ウィンドウ名を "editor" に設定
  # -c: 作業ディレクトリを指定
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  
  # ステップ2: 左側でNeovimを起動（先に起動してから分割する）
  # これにより、Neovimが左側に確実に配置されます
  tmux send-keys -t "$session:editor" "nvim" C-m
  
  # ステップ3: 右側に縦分割（50%: 左半分と右半分）
  # -h: 縦分割（horizontal split、左右に分割）
  # -p 50: 右側を50%にする（左50%、右50%）
  # 結果: ペイン0（左、Neovim）、ペイン1（右）が作成される
  tmux split-window -t "$session:editor" -h -p 50 -c "$dir"
  
  # ステップ4: 右ペイン（ペイン1）を横分割（上50%: ターミナル、下50%: ターミナル）
  # -v: 横分割（vertical split、上下に分割）
  # -p 50: 下側を50%にする
  # 結果: ペイン1（右上）、ペイン2（右下）が作成される
  tmux split-window -t "$session:editor.1" -v -p 50 -c "$dir"
  
  # ステップ5: 左側のペイン（ペイン0、Neovim）にフォーカス
  tmux select-pane -t "$session:editor.0"
  
  echo ""
  echo "💡 devレイアウト作成完了"
  echo "   - 左: Neovim (50%)"
  echo "   - 右上: Terminal (25%)"
  echo "   - 右下: Terminal (25%)"
  echo ""
}

# ========================================
# メイン処理
# ========================================
#
# 【処理フロー】
#   1. 既存セッションの確認
#      - 存在する場合: そのセッションにアタッチして終了
#      - 存在しない場合: 新規セッションを作成
#   2. レイアウトに応じたセッション作成
#   3. セッションにアタッチ
#
# 【既存セッションの扱い】
#   - 既に同じ名前のセッションが存在する場合は、新規作成せずにアタッチします
#   - これにより、誤ってセッションを上書きすることを防ぎます
#   - 新しいセッションを作成したい場合は、別のセッション名を指定してください

# 既存セッションの確認
# has-session: セッションの存在を確認（存在しない場合はエラーを返す）
# 2>/dev/null: エラーメッセージを非表示にする
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "📌 セッション '$SESSION_NAME' は既に存在します"
  echo "   アタッチしています..."
  
  # Tmux内から実行された場合（$TMUX環境変数が設定されている）
  # → switch-clientでセッションを切り替え
  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$SESSION_NAME"
  else
    # Tmux外から実行された場合
    # → attach-sessionでセッションにアタッチ
    tmux attach-session -t "$SESSION_NAME"
  fi
  exit 0
fi

# 新規セッション作成
echo "🚀 セッション '$SESSION_NAME' を作成中..."
echo "   ディレクトリ: $PROJECT_DIR"
echo "   レイアウト: dev"
echo ""

# devレイアウトでセッションを作成
create_dev_layout "$SESSION_NAME" "$PROJECT_DIR"

# セッションにアタッチ
# Tmux内から実行された場合と、Tmux外から実行された場合で処理を分岐
if [ -n "$TMUX" ]; then
  # Tmux内から実行: switch-clientでセッションを切り替え
  tmux switch-client -t "$SESSION_NAME"
else
  # Tmux外から実行: attach-sessionでセッションにアタッチ
  tmux attach-session -t "$SESSION_NAME"
fi

# ========================================
# tmuxコマンドのリファレンス
# ========================================
#
# 【tmuxコマンドのリファレンス】
#   - new-session -d -s <name> -n <window> -c <dir>
#     新しいセッションを作成（-d: デタッチ、-s: セッション名、-n: ウィンドウ名、-c: ディレクトリ）
#   - split-window -t <target> -h -p <percent> -c <dir>
#     ペインを分割（-h: 縦分割、-v: 横分割、-p: パーセンテージ、-c: ディレクトリ）
#   - select-pane -t <target>
#     ペインを選択
#   - send-keys -t <target> <keys> C-m
#     キーを送信（C-m: Enterキー）
#   - has-session -t <name>
#     セッションの存在確認
#   - switch-client -t <name>
#     クライアントを別セッションに切り替え（Tmux内から実行時）
#   - attach-session -t <name>
#     セッションにアタッチ（Tmux外から実行時）
#
# 【ペイン番号の指定方法】
#   - "$session:window.pane" 形式で指定
#   - 例: "$session:editor.0" → editorウィンドウのペイン0
#   - 例: "$session:editor.1" → editorウィンドウのペイン1
#
# 【他のレイアウトについて】
#   - 新しいレイアウトを追加する場合は、別のコマンドファイルを作成することを推奨します
#   - 例: claudeレイアウトは agent コマンドとして実装されています
