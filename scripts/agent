#!/bin/bash

# ========================================
# Tmux Agentレイアウト起動スクリプト
# ========================================
#
# 【概要】
#   Tmuxで開発環境を起動するスクリプトです。
#   均等に5分割したターミナルレイアウトでtmuxセッションを作成します。
#
# 【使用方法】
#   agent                           # カレントディレクトリで起動
#   agent ~/project                 # 指定ディレクトリで起動
#   agent myproject ~/code          # セッション名とディレクトリ指定
#
# 【レイアウト】
#   - 5分割: 全体を均等に5つに分割したターミナル（各20%）
#
# 【編集時の注意点】
#   - tmuxのペイン番号は0から始まります
#   - split-windowは現在のペインを分割し、新しいペインを作成します
#   - ペイン分割の順序が重要です（均等に分割するため、適切なパーセンテージで分割する）
#
# 【tmuxコマンドの説明】
#   - new-session: 新しいセッションを作成
#   - split-window: ペインを分割（-h: 縦分割、-v: 横分割、-p: パーセンテージ）
#   - select-pane: ペインを選択
#   - send-keys: キーを送信（C-m: Enterキー）
#   - has-session: セッションの存在確認
#   - switch-client: クライアントを別セッションに切り替え
#   - attach-session: セッションにアタッチ

set -e

# ========================================
# 設定
# ========================================
#
# 【設定項目】
#   SESSION_PREFIX: セッション名のプレフィックス（省略時は "agent-" が付与される）

SESSION_PREFIX="agent"

# ========================================
# ヘルプ表示
# ========================================

show_help() {
  cat << EOF
Usage: agent [SESSION_NAME] [PROJECT_DIR]

Tmux開発環境を起動します（5分割レイアウト）。

Arguments:
  SESSION_NAME    セッション名（省略時: カレントディレクトリ名）
  PROJECT_DIR     プロジェクトディレクトリ（省略時: カレントディレクトリ）

Options:
  -h, --help            このヘルプを表示

Layout:
  5分割: ┌───┬───┬───┬───┬───┐
         │   │   │   │   │   │
         │ 1 │ 2 │ 3 │ 4 │ 5 │
         │   │   │   │   │   │
         └───┴───┴───┴───┴───┘
         (各20%ずつ均等分割)

Examples:
  agent                           # カレントディレクトリで起動
  agent myproject                 # myprojectセッションで起動
  agent myproject ~/code/myapp    # 指定ディレクトリで起動

EOF
}

# ========================================
# 引数解析
# ========================================
#
# 【引数の優先順位】
#   1. オプション（-h, --help）
#   2. 最初の引数: セッション名
#   3. 2番目の引数: プロジェクトディレクトリ
#
# 【例】
#   agent myproject ~/code
#   → SESSION_NAME="myproject", PROJECT_DIR="~/code"

SESSION_NAME=""
PROJECT_DIR=""

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      # 最初の引数はセッション名、2番目はプロジェクトディレクトリ
      if [ -z "$SESSION_NAME" ]; then
        SESSION_NAME="$1"
      elif [ -z "$PROJECT_DIR" ]; then
        PROJECT_DIR="$1"
      fi
      shift
      ;;
  esac
done

# ========================================
# デフォルト値設定
# ========================================
#
# 【デフォルト値の決定ロジック】
#   1. PROJECT_DIR: 未指定時はカレントディレクトリ（$(pwd)）
#   2. SESSION_NAME: 未指定時は "agent-<ディレクトリ名>" 形式で生成

# プロジェクトディレクトリのデフォルト
if [ -z "$PROJECT_DIR" ]; then
  PROJECT_DIR="$(pwd)"
fi

# セッション名のデフォルト（ディレクトリ名から生成）
# 例: ~/code/myproject → "agent-myproject"
if [ -z "$SESSION_NAME" ]; then
  SESSION_NAME="${SESSION_PREFIX}-$(basename "$PROJECT_DIR")"
fi

# ディレクトリの存在確認
if [ ! -d "$PROJECT_DIR" ]; then
  echo "Error: Directory not found: $PROJECT_DIR"
  exit 1
fi

# ========================================
# セッション作成関数
# ========================================
#
create_claude_layout() {
  local session=$1
  local dir=$2
  
  # ステップ1: セッションを作成（ペイン0が作成される）
  # -d: デタッチモードで作成（すぐにアタッチしない）
  # -n: ウィンドウ名を "editor" に設定
  # -c: 作業ディレクトリを指定
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  
  # ステップ2: 全体を均等に5分割する
  # -h: 縦分割（horizontal split、左右に分割）
  # 
  # 分割1: ペイン0を20%と80%に分割 → ペイン0（20%）、ペイン1（80%）
  tmux split-window -t "$session:editor.0" -h -p 20 -c "$dir"
  # 分割2: ペイン1を20%と80%に分割 → ペイン1（20%）、ペイン2（80%）
  tmux split-window -t "$session:editor.1" -h -p 20 -c "$dir"
  # 分割3: ペイン2を20%と80%に分割 → ペイン2（20%）、ペイン3（80%）
  tmux split-window -t "$session:editor.2" -h -p 20 -c "$dir"
  # 分割4: ペイン3を20%と80%に分割 → ペイン3（20%）、ペイン4（80%）
  tmux split-window -t "$session:editor.3" -h -p 20 -c "$dir"
  # 分割5: ペイン4を20%と80%に分割 → ペイン4（20%）、ペイン5（80%）
  tmux split-window -t "$session:editor.4" -h -p 20 -c "$dir"
  tmux split-window -t "$session:editor.5" -h -p 20 -c "$dir"
  
  # ステップ3: 最初のペイン（ペイン0）にフォーカス
  tmux select-pane -t "$session:editor.0"
  
  echo ""
  echo "💡 5分割レイアウト作成完了"
  echo "   - 5つのターミナル (各20%)"
  echo ""
}

# ========================================
# メイン処理
# ========================================
#
# 【処理フロー】
#   1. 既存セッションの確認
#      - 存在する場合: そのセッションにアタッチして終了
#      - 存在しない場合: 新規セッションを作成
#   2. claudeレイアウトでセッション作成
#   3. セッションにアタッチ
#
# 【既存セッションの扱い】
#   - 既に同じ名前のセッションが存在する場合は、新規作成せずにアタッチします
#   - これにより、誤ってセッションを上書きすることを防ぎます
#   - 新しいセッションを作成したい場合は、別のセッション名を指定してください

# 既存セッションの確認
# has-session: セッションの存在を確認（存在しない場合はエラーを返す）
# 2>/dev/null: エラーメッセージを非表示にする
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "📌 セッション '$SESSION_NAME' は既に存在します"
  echo "   アタッチしています..."
  
  # Tmux内から実行された場合（$TMUX環境変数が設定されている）
  # → switch-clientでセッションを切り替え
  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$SESSION_NAME"
  else
    # Tmux外から実行された場合
    # → attach-sessionでセッションにアタッチ
    tmux attach-session -t "$SESSION_NAME"
  fi
  exit 0
fi

# 新規セッション作成
echo "🚀 セッション '$SESSION_NAME' を作成中..."
echo "   ディレクトリ: $PROJECT_DIR"
echo "   レイアウト: 5分割"
echo ""

# 5分割レイアウトでセッションを作成
create_claude_layout "$SESSION_NAME" "$PROJECT_DIR"

# セッションにアタッチ
# Tmux内から実行された場合と、Tmux外から実行された場合で処理を分岐
if [ -n "$TMUX" ]; then
  # Tmux内から実行: switch-clientでセッションを切り替え
  tmux switch-client -t "$SESSION_NAME"
else
  # Tmux外から実行: attach-sessionでセッションにアタッチ
  tmux attach-session -t "$SESSION_NAME"
fi
