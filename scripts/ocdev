#!/bin/bash

# ========================================
# OpenCode + 開発環境統合スクリプト
# ========================================
#
# 【概要】
#   OpenCodeと開発環境を統合したワークフローを提供します。
#   Tmuxセッション内でOpenCodeを起動し、効率的な開発環境を構築します。
#
# 【使用方法】
#   ocdev                           # カレントディレクトリでOpenCodeを起動
#   ocdev ~/project                 # 指定ディレクトリで起動
#   ocdev myproject ~/code          # セッション名とディレクトリ指定
#   ocdev --model GLM-4.7            # モデルを指定して起動
#   ocdev --layout split             # レイアウトを指定
#
# 【レイアウト】
#   - default: 左半分OpenCode、右半分ターミナル
#   - split: 上下分割（上: OpenCode、下: ターミナル）
#   - full: OpenCodeフルスクリーン
#

set -e

# ========================================
# 設定
# ========================================

SESSION_PREFIX="ocdev"
DEFAULT_MODEL="GLM-4.7"
LAYOUT="default"

# ========================================
# ヘルプ表示
# ========================================

show_help() {
  cat << EOF
Usage: ocdev [OPTIONS] [SESSION_NAME] [PROJECT_DIR]

OpenCode + 開発環境を起動します。

Arguments:
  SESSION_NAME    セッション名（省略時: カレントディレクトリ名）
  PROJECT_DIR     プロジェクトディレクトリ（省略時: カレントディレクトリ）

Options:
  -h, --help            このヘルプを表示
  -m, --model MODEL     OpenCodeで使用するモデル（デフォルト: GLM-4.7）
  -l, --layout LAYOUT   レイアウトを指定（default, split, full）
  --no-opencode          OpenCodeを起動しない（ターミナルのみ）

Layouts:
  default: ┌──────────┬──────────┐
           │ OpenCode │ Terminal │
           │ (50%)    │ (50%)    │
           └──────────┴──────────┘
  
  split:   ┌──────────────┐
           │ OpenCode     │
           │ (50%)        │
           ├──────────────┤
           │ Terminal     │
           │ (50%)        │
           └──────────────┘
  
  full:    ┌──────────────┐
           │              │
           │ OpenCode     │
           │ (100%)       │
           │              │
           └──────────────┘

Examples:
  ocdev                           # カレントディレクトリで起動
  ocdev myproject                 # myprojectセッションで起動
  ocdev myproject ~/code/myapp    # 指定ディレクトリで起動
  ocdev --model GLM-4.7            # モデルを指定
  ocdev --layout split             # レイアウトを指定

EOF
}

# ========================================
# 引数解析
# ========================================

SESSION_NAME=""
PROJECT_DIR=""
MODEL="$DEFAULT_MODEL"
NO_OPENCODE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    -m|--model)
      MODEL="$2"
      shift 2
      ;;
    -l|--layout)
      LAYOUT="$2"
      shift 2
      ;;
    --no-opencode)
      NO_OPENCODE=true
      shift
      ;;
    *)
      if [ -z "$SESSION_NAME" ]; then
        SESSION_NAME="$1"
      elif [ -z "$PROJECT_DIR" ]; then
        PROJECT_DIR="$1"
      fi
      shift
      ;;
  esac
done

# ========================================
# デフォルト値設定
# ========================================

if [ -z "$PROJECT_DIR" ]; then
  PROJECT_DIR="$(pwd)"
fi

if [ -z "$SESSION_NAME" ]; then
  SESSION_NAME="${SESSION_PREFIX}-$(basename "$PROJECT_DIR")"
fi

# ディレクトリの存在確認
if [ ! -d "$PROJECT_DIR" ]; then
  echo "Error: Directory not found: $PROJECT_DIR"
  exit 1
fi

# OpenCodeの存在確認
if [ "$NO_OPENCODE" = false ] && ! command -v opencode &> /dev/null; then
  echo "Error: OpenCode is not installed"
  echo "Install it with: curl -fsSL https://opencode.ai/install | bash"
  echo "Or run: ocdev --no-opencode to start without OpenCode"
  exit 1
fi

# ========================================
# レイアウト作成関数
# ========================================

create_default_layout() {
  local session=$1
  local dir=$2
  local model=$3
  local no_opencode=$4
  
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  
  # 右側に縦分割（50%: 左半分と右半分）
  tmux split-window -t "$session:editor.0" -h -p 50 -c "$dir"
  
  # 左側のペイン（ペイン0）にフォーカス
  tmux select-pane -t "$session:editor.0"
  
  # OpenCodeを起動（オプション）
  if [ "$no_opencode" = false ]; then
    sleep 0.1
    if [ -n "$model" ]; then
      tmux send-keys -t "$session:editor.0" "opencode --model $model" C-m
    else
      tmux send-keys -t "$session:editor.0" "opencode" C-m
    fi
  fi
  
  echo ""
  echo "💡 defaultレイアウト作成完了"
  echo "   - 左: OpenCode (50%)"
  echo "   - 右: Terminal (50%)"
  if [ -n "$model" ]; then
    echo "   - モデル: $model"
  fi
  echo ""
}

create_split_layout() {
  local session=$1
  local dir=$2
  local model=$3
  local no_opencode=$4
  
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  
  # 下側に横分割（50%: 上半分と下半分）
  tmux split-window -t "$session:editor.0" -v -p 50 -c "$dir"
  
  # 上側のペイン（ペイン0）にフォーカス
  tmux select-pane -t "$session:editor.0"
  
  # OpenCodeを起動（オプション）
  if [ "$no_opencode" = false ]; then
    sleep 0.1
    if [ -n "$model" ]; then
      tmux send-keys -t "$session:editor.0" "opencode --model $model" C-m
    else
      tmux send-keys -t "$session:editor.0" "opencode" C-m
    fi
  fi
  
  echo ""
  echo "💡 splitレイアウト作成完了"
  echo "   - 上: OpenCode (50%)"
  echo "   - 下: Terminal (50%)"
  if [ -n "$model" ]; then
    echo "   - モデル: $model"
  fi
  echo ""
}

create_full_layout() {
  local session=$1
  local dir=$2
  local model=$3
  local no_opencode=$4
  
  tmux new-session -d -s "$session" -n "editor" -c "$dir"
  
  # OpenCodeを起動（オプション）
  if [ "$no_opencode" = false ]; then
    sleep 0.1
    if [ -n "$model" ]; then
      tmux send-keys -t "$session:editor.0" "opencode --model $model" C-m
    else
      tmux send-keys -t "$session:editor.0" "opencode" C-m
    fi
  fi
  
  echo ""
  echo "💡 fullレイアウト作成完了"
  echo "   - OpenCode (100%)"
  if [ -n "$model" ]; then
    echo "   - モデル: $model"
  fi
  echo ""
}

# ========================================
# メイン処理
# ========================================

# 既存セッションの確認
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "📌 セッション '$SESSION_NAME' は既に存在します"
  echo "   アタッチしています..."
  
  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$SESSION_NAME"
  else
    tmux attach-session -t "$SESSION_NAME"
  fi
  exit 0
fi

# 新規セッション作成
echo "🚀 セッション '$SESSION_NAME' を作成中..."
echo "   ディレクトリ: $PROJECT_DIR"
echo "   レイアウト: $LAYOUT"
if [ "$NO_OPENCODE" = false ]; then
  echo "   モデル: $MODEL"
fi
echo ""

# レイアウトに応じてセッションを作成
case "$LAYOUT" in
  default)
    create_default_layout "$SESSION_NAME" "$PROJECT_DIR" "$MODEL" "$NO_OPENCODE"
    ;;
  split)
    create_split_layout "$SESSION_NAME" "$PROJECT_DIR" "$MODEL" "$NO_OPENCODE"
    ;;
  full)
    create_full_layout "$SESSION_NAME" "$PROJECT_DIR" "$MODEL" "$NO_OPENCODE"
    ;;
  *)
    echo "Error: Unknown layout: $LAYOUT"
    echo "Available layouts: default, split, full"
    exit 1
    ;;
esac

# セッションにアタッチ
if [ -n "$TMUX" ]; then
  tmux switch-client -t "$SESSION_NAME"
else
  tmux attach-session -t "$SESSION_NAME"
fi
